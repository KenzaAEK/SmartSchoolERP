variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

stages:
  - test
  - build

backend-test:
  stage: test
  image: maven:3.9.2-eclipse-temurin-17
  script:
    - mvn -B -f backend/pom.xml test
  only:
    - branches

frontend-test:
  stage: test
  image: node:18
  before_script:
    - cd frontend
  cache:
    paths:
      - frontend/node_modules/
  script:
    - npm ci
    - npm test --if-present
  only:
    - branches

python-tests:
  stage: test
  image: python:3.11
  before_script:
    - cd ai-services/recommendation || exit 0
    - if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
  script:
    - if command -v pytest >/dev/null 2>&1; then pytest -q || exit 1; else echo "no pytest, skipping"; fi
  allow_failure: true
  only:
    - branches

.build-template:
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - docker info || true

backend-build:
  extends: .build-template
  stage: build
  script:
    - docker build -t "${CI_PROJECT_PATH}/backend:${CI_COMMIT_SHORT_SHA}" -f backend/Dockerfile backend
    - |
      if [ -n "$CI_REGISTRY" ] && [ -n "$CI_REGISTRY_USER" ]; then
        echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
        docker tag "${CI_PROJECT_PATH}/backend:${CI_COMMIT_SHORT_SHA}" "${CI_REGISTRY}/${CI_PROJECT_PATH}/backend:${CI_COMMIT_SHORT_SHA}"
        docker push "${CI_REGISTRY}/${CI_PROJECT_PATH}/backend:${CI_COMMIT_SHORT_SHA}"
      fi

frontend-build:
  extends: .build-template
  stage: build
  script:
    - cd frontend
    - npm ci
    - npm run build
    - echo 'FROM nginx:stable-alpine' > Dockerfile
    - echo 'COPY dist/ /usr/share/nginx/html' >> Dockerfile
    - echo 'EXPOSE 80' >> Dockerfile
    - docker build -t "${CI_PROJECT_PATH}/frontend:${CI_COMMIT_SHORT_SHA}" .
    - |
      if [ -n "$CI_REGISTRY" ] && [ -n "$CI_REGISTRY_USER" ]; then
        echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
        docker tag "${CI_PROJECT_PATH}/frontend:${CI_COMMIT_SHORT_SHA}" "${CI_REGISTRY}/${CI_PROJECT_PATH}/frontend:${CI_COMMIT_SHORT_SHA}"
        docker push "${CI_REGISTRY}/${CI_PROJECT_PATH}/frontend:${CI_COMMIT_SHORT_SHA}"
      fi

ai-recommendation-build:
  extends: .build-template
  stage: build
  script:
    - docker build -t "${CI_PROJECT_PATH}/ai-recommendation:${CI_COMMIT_SHORT_SHA}" -f ai-services/recommendation/Dockerfile ai-services/recommendation
    - |
      if [ -n "$CI_REGISTRY" ] && [ -n "$CI_REGISTRY_USER" ]; then
        echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
        docker tag "${CI_PROJECT_PATH}/ai-recommendation:${CI_COMMIT_SHORT_SHA}" "${CI_REGISTRY}/${CI_PROJECT_PATH}/ai-recommendation:${CI_COMMIT_SHORT_SHA}"
        docker push "${CI_REGISTRY}/${CI_PROJECT_PATH}/ai-recommendation:${CI_COMMIT_SHORT_SHA}"
      fi

ai-scheduler-build:
  extends: .build-template
  stage: build
  script:
    - docker build -t "${CI_PROJECT_PATH}/ai-scheduler:${CI_COMMIT_SHORT_SHA}" -f ai-services/schedule-optimizer/Dockerfile ai-services/schedule-optimizer
    - |
      if [ -n "$CI_REGISTRY" ] && [ -n "$CI_REGISTRY_USER" ]; then
        echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
        docker tag "${CI_PROJECT_PATH}/ai-scheduler:${CI_COMMIT_SHORT_SHA}" "${CI_REGISTRY}/${CI_PROJECT_PATH}/ai-scheduler:${CI_COMMIT_SHORT_SHA}"
        docker push "${CI_REGISTRY}/${CI_PROJECT_PATH}/ai-scheduler:${CI_COMMIT_SHORT_SHA}"
      fi
